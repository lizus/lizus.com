<!DOCTYPE html>
<html lang="zh_CN">



  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
        <meta name="author" content="Lizus" />
        
          <meta name="keywords" content="sitemap,github copilot,lizus,WordPress,javascript,css,WordPress theme,WordPress plugin,WordPress定制,hexo,html5,css3" />
          
              <title>
                
                        如何定制WordPress的Sitemap输出 - Lizus | An Developer
                              
              </title>
              <meta name="description" content="对于SEO来说，sitemap是必备的，WordPress从5.5版本开始内置了sitemap的输出✈。 默认情况下，WordPress会将站内所有文章类型（public）的列表（包括自定义文章），所有分类列表（taxonomy）以及有发布文章的作者列表都分别输出成xml格式的sitemap，然后用wp-sitemap.xml做一个索引。一般情况下，这样的输出就足够了。 但有时候需求会有点不一样，">
<meta property="og:type" content="article">
<meta property="og:title" content="如何定制WordPress的Sitemap输出">
<meta property="og:url" content="https://lizus.com/wordpress/custom-wordpress-sitemap/index.html">
<meta property="og:site_name" content="Lizus">
<meta property="og:description" content="对于SEO来说，sitemap是必备的，WordPress从5.5版本开始内置了sitemap的输出✈。 默认情况下，WordPress会将站内所有文章类型（public）的列表（包括自定义文章），所有分类列表（taxonomy）以及有发布文章的作者列表都分别输出成xml格式的sitemap，然后用wp-sitemap.xml做一个索引。一般情况下，这样的输出就足够了。 但有时候需求会有点不一样，">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-10-20T02:33:10.000Z">
<meta property="article:modified_time" content="2024-06-27T07:04:00.307Z">
<meta property="article:author" content="Lizus">
<meta property="article:tag" content="sitemap">
<meta property="article:tag" content="seo">
<meta name="twitter:card" content="summary">
                
    <link rel="apple-touch-icon" href="/static/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon/favicon-16x16.png ">
    <link rel="manifest" href="/static/favicon/site.webmanifest">
    
                  
<link rel="stylesheet" href="/static/css/styles.css?v=1.0.3.css">

                    
                      
<link rel="stylesheet" href="/%20/static/css/github-markdown.css">

                    
<link rel="stylesheet" href="/%20/static/css/highlight.css">

                      
                        
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ELQNXEJ6TK"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-ELQNXEJ6TK');
    </script>
    
  </head>

  <body>
    <div id="app" class="app">
      <header class="header">
    <h2 class="site-logo"><a href="https://lizus.com ">Lizus</a></h2>
    <ul class="menu">
        
            <li>
                <a href="/" target="_self">
                    Home
                </a>
            </li>
            
            <li>
                <a href="/wordpress/why-choose-wordpress" target="_self">
                    为什么用WordPress
                </a>
            </li>
            
            <li>
                <a href="/wordpress/why-you-need-a-website" target="_self">
                    为什么要有网站
                </a>
            </li>
            
            <li>
                <a href="/about" target="_self">
                    关于我
                </a>
            </li>
            
    </ul>
</header>
        <section class="main">
          <article class="post">
  <h1 class="article-title">
    如何定制WordPress的Sitemap输出
  </h1>
  <div class="content markdown-body">
    <p>对于SEO来说，sitemap是必备的，WordPress从5.5版本开始内置了sitemap的输出<sup><a target="_blank" rel="noopener" href="https://make.wordpress.org/core/2020/07/22/new-xml-sitemaps-functionality-in-wordpress-5-5/">✈</a></sup>。</p>
<p>默认情况下，WordPress会将站内所有文章类型（public）的列表（包括自定义文章），所有分类列表（taxonomy）以及有发布文章的作者列表都分别输出成xml格式的sitemap，然后用wp-sitemap.xml做一个索引。一般情况下，这样的输出就足够了。</p>
<p>但有时候需求会有点不一样，比如不想输出page类型，或者有些作者不想加入到作者列表中，等等。另一方面，因为是动态文件，所以如果流量比较大的网站，或者服务器不是太好的站点，在拉取sitemap的时候可能就比较吃资源，所以还会有优化的需求。</p>
<p>照例WordPress提供了一些勾子来解决这些定制需求。在<a target="_blank" rel="noopener" href="https://make.wordpress.org/core/2020/07/22/new-xml-sitemaps-functionality-in-wordpress-5-5/">官方sitemap说明文档</a>中介绍了常用的几种情况：</p>
<blockquote>
<ul>
<li>如何在sitemap中移除某种列表的输出</li>
<li>如何在sitemap中移除某些不想要出现的文章类型列表</li>
<li>如何在sitemap中移除某些不想要出现的分类类型列表</li>
<li>如何定制在sitemap中出一的链接数据，如lastmod,changefreq和priority</li>
<li>如何控制在sitemap中输出的具体列表内容</li>
<li>如何关闭sitemap</li>
</ul>
</blockquote>
<p>以上问题都可以在<a target="_blank" rel="noopener" href="https://make.wordpress.org/core/2020/07/22/new-xml-sitemaps-functionality-in-wordpress-5-5/">WordPress官方sitemap说明文档</a>中的<code>Configuring Sitemaps Behavior</code>一节中找到解决方案，这里不再赘述。</p>
<p>本文分享几个个人使用中的小技巧，直接上代码。</p>
<h2 id="输出所有用户主页（或用户文章列表页）"><a href="#输出所有用户主页（或用户文章列表页）" class="headerlink" title="输出所有用户主页（或用户文章列表页）"></a>输出所有用户主页（或用户文章列表页）</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">add_filter</span>(</span><br><span class="line">    <span class="string">&#x27;wp_sitemaps_users_query_args&#x27;</span>,</span><br><span class="line">    function( <span class="variable">$args</span>) &#123;</span><br><span class="line">        <span class="variable">$args</span>[<span class="string">&#x27;has_published_posts&#x27;</span>]=<span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$args</span>;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="更改用户主页（或用户文章列表页）地址"><a href="#更改用户主页（或用户文章列表页）地址" class="headerlink" title="更改用户主页（或用户文章列表页）地址"></a>更改用户主页（或用户文章列表页）地址</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">add_filter</span>(<span class="string">&#x27;wp_sitemaps_users_entry&#x27;</span>,function( <span class="variable">$entry</span>,<span class="variable">$user</span>) &#123;</span><br><span class="line">    <span class="variable">$entry</span>[<span class="string">&#x27;loc&#x27;</span>]=<span class="title function_ invoke__">home_url</span>(<span class="string">&#x27;/user/&#x27;</span>.<span class="variable">$user</span>-&gt;ID);<span class="comment">//需要更改的用户页地址</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$entry</span>;</span><br><span class="line">&#125;,<span class="number">10</span>,<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<h2 id="缓存所有文章类型列表的sitemap"><a href="#缓存所有文章类型列表的sitemap" class="headerlink" title="缓存所有文章类型列表的sitemap"></a>缓存所有文章类型列表的sitemap</h2><p>使用wordpress的<code>get_transient</code>和<code>set_transient</code>函数来缓存sitemap数据，则在以后拉取的时候不用再做sql查询。如果配合redis等缓存，则效果更佳。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">add_filter</span>(<span class="string">&#x27;wp_sitemaps_posts_pre_url_list&#x27;</span>,function(<span class="variable">$list</span>,<span class="variable">$post_type</span>,<span class="variable">$page_num</span>)&#123;</span><br><span class="line">    <span class="variable">$num</span>=<span class="title function_ invoke__">wp_sitemaps_get_max_urls</span>(<span class="string">&#x27;post&#x27;</span>);</span><br><span class="line">    <span class="variable">$args</span>=[</span><br><span class="line">        <span class="string">&#x27;orderby&#x27;</span>                =&gt; <span class="string">&#x27;ID&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;order&#x27;</span>                  =&gt; <span class="string">&#x27;ASC&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;post_type&#x27;</span>              =&gt; <span class="variable">$post_type</span>,</span><br><span class="line">        <span class="string">&#x27;posts_per_page&#x27;</span>         =&gt; <span class="variable">$num</span>,</span><br><span class="line">        <span class="string">&#x27;post_status&#x27;</span>            =&gt; <span class="keyword">array</span>( <span class="string">&#x27;publish&#x27;</span> ),</span><br><span class="line">        <span class="string">&#x27;no_found_rows&#x27;</span>          =&gt; <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&#x27;fields&#x27;</span>          =&gt; <span class="string">&#x27;ids&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">    <span class="variable">$args</span>[<span class="string">&#x27;paged&#x27;</span>] = <span class="variable">$page_num</span>;</span><br><span class="line">    <span class="variable">$key</span>=<span class="string">&#x27;wp_sitemaps_posts_pre_url_list:&#x27;</span>.<span class="variable">$post_type</span>.<span class="string">&#x27;:&#x27;</span>.<span class="variable">$num</span>.<span class="string">&#x27;:&#x27;</span>.<span class="variable">$page_num</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span> === (<span class="variable">$data</span> = <span class="title function_ invoke__">get_transient</span>(<span class="variable">$key</span>))) &#123;</span><br><span class="line">        <span class="variable">$url_list</span>=[];</span><br><span class="line">        <span class="variable">$query</span> = <span class="keyword">new</span> <span class="title class_">WP_Query</span>( <span class="variable">$args</span> );</span><br><span class="line">        <span class="keyword">foreach</span> ( <span class="variable">$query</span>-&gt;posts <span class="keyword">as</span> <span class="variable">$post</span> ) &#123;</span><br><span class="line">			<span class="variable">$url_list</span>[] = [</span><br><span class="line">				<span class="string">&#x27;loc&#x27;</span> =&gt; <span class="title function_ invoke__">get_permalink</span>( <span class="variable">$post</span> ),</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">count</span>(<span class="variable">$url_list</span>)&gt;=<span class="variable">$num</span>) &#123;<span class="comment">//判断如果当前页输出还没到最大值，则不缓存该页数据，可以达到及时更新的目的。</span></span><br><span class="line">            <span class="title function_ invoke__">set_transient</span>(<span class="variable">$key</span>,<span class="variable">$url_list</span>,<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$data</span>=<span class="variable">$url_list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$data</span>)) <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$list</span>;</span><br><span class="line"></span><br><span class="line">&#125;,<span class="number">10</span>,<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<h2 id="缓存所有作者列表的sitemap"><a href="#缓存所有作者列表的sitemap" class="headerlink" title="缓存所有作者列表的sitemap"></a>缓存所有作者列表的sitemap</h2><p>默认的作者页输出时使用login及用户名首字母排序，我们将其改成ID排序，则除了最后一页之后，所有列表几乎不再更改，就可以使用缓存了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">add_filter</span>(<span class="string">&#x27;wp_sitemaps_users_pre_url_list&#x27;</span>,function(<span class="variable">$list</span>,<span class="variable">$page_num</span>)&#123;</span><br><span class="line">    <span class="variable">$num</span>=<span class="title function_ invoke__">wp_sitemaps_get_max_urls</span>(<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line">    <span class="variable">$args</span>[<span class="string">&#x27;has_published_posts&#x27;</span>] = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable">$args</span>[<span class="string">&#x27;paged&#x27;</span>] = <span class="variable">$page_num</span>;</span><br><span class="line">    <span class="variable">$args</span>[<span class="string">&#x27;number&#x27;</span>]= <span class="variable">$num</span>;</span><br><span class="line">    <span class="variable">$args</span>[<span class="string">&#x27;fields&#x27;</span>] = [<span class="string">&#x27;ID&#x27;</span>];</span><br><span class="line">    <span class="variable">$args</span>[<span class="string">&#x27;orderby&#x27;</span>] = [<span class="string">&#x27;ID&#x27;</span>];</span><br><span class="line">    <span class="variable">$key</span>=<span class="string">&#x27;wp_sitemaps_users_pre_url_list:&#x27;</span>.<span class="variable">$num</span>.<span class="string">&#x27;:&#x27;</span>.<span class="variable">$page_num</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span> === (<span class="variable">$data</span> = <span class="title function_ invoke__">get_transient</span>(<span class="variable">$key</span>))) &#123;</span><br><span class="line">        <span class="variable">$url_list</span>=[];</span><br><span class="line">        <span class="variable">$query</span>    = <span class="keyword">new</span> <span class="title class_">WP_User_Query</span>( <span class="variable">$args</span> );</span><br><span class="line">        <span class="variable">$users</span>    = <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">get_results</span>();</span><br><span class="line">        <span class="keyword">foreach</span> ( <span class="variable">$users</span> <span class="keyword">as</span> <span class="variable">$user</span> ) &#123;</span><br><span class="line">            <span class="variable">$url_list</span>[]    = [</span><br><span class="line">                <span class="string">&#x27;loc&#x27;</span> =&gt; <span class="title function_ invoke__">home_url</span>( <span class="string">&#x27;/user/&#x27;</span>.<span class="variable">$user</span>-&gt;ID ),</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">count</span>(<span class="variable">$url_list</span>)&gt;=<span class="variable">$num</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">set_transient</span>(<span class="variable">$key</span>,<span class="variable">$url_list</span>,<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$data</span>=<span class="variable">$url_list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$data</span>)) <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$list</span>;</span><br><span class="line">&#125;,<span class="number">10</span>,<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<h2 id="BTW"><a href="#BTW" class="headerlink" title="BTW"></a>BTW</h2><blockquote>
<p>需要提交百度sitemap的童鞋一定要注意，百度已不支持索引型sitemap，所以必须要将wp-sitemap.xml中所列的地址一个一个提交到百度站长工具中。（并不明白为何百度要这样折磨站长们）</p>
</blockquote>

  </div>
  
    <h3 class="article-meta">
      
        
          <span>
            <a href="https://lizus.com/categories/wordpress/ ">
              wordpress
            </a>
          </span>
          
            
              
                
                  <span>
                    <a href="https://lizus.com/tags/sitemap/ ">
                      sitemap
                    </a>
                  </span>
                  
                  <span>
                    <a href="https://lizus.com/tags/seo/ ">
                      seo
                    </a>
                  </span>
                  
                    
    </h3>
    
</article>

  <nav class="post-navigation">
    <span class="nav-item prev">
      
        <a class="nav-item-a" href="https://lizus.com/wordpress/custom-wordpress-sitemap-under-5.5/">
          WordPress版本低于5.5的话怎么定制sitemap输出
        </a>
        
    </span>
    <span class="nav-item next">
      
        <a class="nav-item-a" href="https://lizus.com/html5/html5-video-background-solution/">
          HTML5 video background solution(网页视频融入背景兼容解决方案)
        </a>
        
    </span>
  </nav>
  
        </section>
        <footer class="footer">
    <h2 class="logo">
    <svg xmlns="http://www.w3.org/2000/svg" version="1.1" xlink="http://www.w3.org/1999/xlink"
        xmlns:svgjs="http://svgjs.com/svgjs" width="100%" height="100%" viewBox="14 2 36 60">
        <g>
            <path
                d="M45 36h-3v-4H14v25c0 2.8 2.2 5 5 5h18c2.8 0 5-2.2 5-5v-3h3c2.8 0 5-2.2 5-5v-8c0-2.8-2.2-5-5-5zM23.9 54.5l-1.7 1-4.4-7.5 4.3-7.5 1.7 1-3.6 6.5 3.7 6.5zm3.1.8l-2-.6 4-14 1.9.5L27 55.3zm6.9.2l-1.7-1 3.7-6.5-3.7-6.5 1.7-1 4.3 7.5-4.3 7.5zM48 49c0 1.7-1.3 3-3 3h-3V38h3c1.7 0 3 1.3 3 3v8zM38 30h-2v-2c0-1.1-.9-2-2-2H20c-2.2 0-4-1.8-4-4s1.8-4 4-4h14c1.1 0 2-.9 2-2s-.9-2-2-2H20c-2.2 0-4-1.8-4-4s1.8-4 4-4h14c1.1 0 2-.9 2-2V2h2v2c0 2.2-1.8 4-4 4H20c-1.1 0-2 .9-2 2s.9 2 2 2h14c2.2 0 4 1.8 4 4s-1.8 4-4 4H20c-1.1 0-2 .9-2 2s.9 2 2 2h14c2.2 0 4 1.8 4 4v2z">
            </path>
        </g>
    </svg>
    <i class="hline"></i>
    <strong>Lizus</strong>
    <i class="hline"></i>
    <em>A WordPress Coder</em>
</h2>
        
            <p class="footer-p">
                
                        Developer Logs. Sometimes left , sometimes write.
                            
            </p>
            
            <p class="footer-p">
                
                        Copyright © 2024
                            
            </p>
            
</footer>
    </div>
  </body>

</html>